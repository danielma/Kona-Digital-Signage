/* 
  Calparse.js
  by Daniel Ma (danielghma@gmail.com)

  Written for the digital signage system at YWAM Kona
  4th qtr 2011
*//*jshint forin:true, noarg:true, noempty:true, eqeqeq:true, bitwise:true, strict:true, undef:true, curly:true, browser:true, jquery:true, maxerr:50 *//*global google*//*
  Title: Calparse.js
  One file with all the classes, objects, and functions to run the DigitalSignage app (or http://gniux.uofnkona.edu/)
  
  About: Format Strings
  
  Description:
  Understanding how format strings work in Calparse.js is required to properly configure the DigitalSignage app

.

  The syntax of the special format strings used here allows for custom formatting of dates, titles, and descriptions                       

.

  Format strings consist of formatters in the form t(), d(), etc and sometimes with a format string inside the parentheses. Formatting within parentheses is processed using the DateJS <toString at http://code.google.com/p/datejs/wiki/FormatSpecifiers> method
  
  (start code)
  Format      Description             
  ----------- -------------------------       
  s(format)   The start time formatted 
  e(format)   The end time formatted 
  t()         The title
  d()         The description   
  
  \n          Newline
  |           For use in tables, divides <td> cells
  (end) 
  
  Examples:
  > "s(dddd, MMMM d at h:mm tt)"            -> "Monday, December 1 at 7:00 PM"
  > "s(dddd, MMMM d h:mm tt) - e(h:mm tt)"  -> "Monday, December 1 7:00 PM - 9:00 PM"
  > "t()|-|d()"                             -> "<td>Event Title</td><td>-</td><td>A Really cool event!</td>"
  > "s(h:mm) - e(h:mm tt)|-|t()"            -> "<td>7:00 - 9:00 PM</td><td>-</td><td>Event Title</td>"
  
  See Also:
  <DateJS Format Strings at http://code.google.com/p/datejs/wiki/FormatSpecifiers>    
*//*
  Array: tickers
  A global array containing all the tickers being used on the page
*/function appendScript(e){"use strict";var t=document.createElement("script");t.setAttribute("type","text/javascript"),t.setAttribute("src",e),document.getElementsByTagName("head")[0].appendChild(t)}function Event(e){"use strict";typeof e!="undefined"&&(this.title=e.title,this.start_time=e.start_time||Date.today(),this.end_time=e.end_time||Date.today().set({hour:23,minute:59,second:59}),this.location=e.location||"",this.description=e.description||"",this.attachment=e.attachment)}function Ticker(e){"use strict";this.addItem=function(e){this.element.append(e),this.items.push(e),this.setSize(),this.running||this.start()},this.start=function(){this.running&&clearInterval(this.interval),this.interval=setInterval(this.rotate,this.speed),this.running=!0},this.stop=function(){clearInterval(this.interval),this.running=!1},this.rotate=function(){t.items.length>1?$(t.element.children()[t.currentItem]).fadeOut(function(){t.stepCurrentItem(),$(t.element.children()[t.currentItem]).fadeIn()}):($(t.element.children()[0]).fadeIn(),t.stop())},this.stepCurrentItem=function(){this.currentItem+=1,this.currentItem>this.items.length-1&&(this.currentItem=0)},this.setSize=function(){var e=this.element.parent().outerHeight(),t=this.element.siblings().outerHeight(),n=this.element.outerHeight()-this.element.height();this.tickerHeight=e-t-n,this.element.find("img").css("height",this.tickerHeight+"px")};var t=this;typeof e!="undefined"&&(this.element=$(e.element),this.items=e.items||[],this.speed=e.speed||1e4,this.running=e.running||!1,this.currentItem=0,this.interval=null,this.tickerHeight=0),this.setSize(),this.running&&this.start(),tickers.push(this)}var tickers=[];String.prototype.capitalize=function(){"use strict";return this.replace(/(^|\s)([a-z])/g,function(e,t,n){return t+n.toUpperCase()})},String.prototype.repeat=function(e){"use strict";return[e+1].join(this)};var by_mealtime=function(e,t){"use strict";var n=[e,t];for(var r=0;r<n.length;r++)switch(n[r].title.toLowerCase()){case"breakfast":n[r]=0;break;case"lunch":n[r]=1;break;case"dinner":n[r]=2;break;default:}return n[0]-n[1]},by_time=function(e,t){"use strict";return e.start_time-t.start_time},videoPlayer={list:["1.webm","2.webm"],path:"videos/",currentVideo:0,element:null,fnQueue:[],playVideos:function(e){"use strict";typeof e!="undefined"&&(this.list=e.list||this.list,this.path=e.path||this.path),$("#video .content").html("<video id='videoPlayer' src='"+this.path+this.list[0]+"' autoplay autobuffer />");var t=$("#video"),n=t.children().outerHeight()-t.children().height(),r=t.outerHeight()-n;this.element=$("#videoPlayer"),this.element.css("max-height",r+"px").bind("ended",function(){videoPlayer.nextVideo()})},nextVideo:function(){"use strict";if(this.fnQueue.length>0)for(var e=0;e<this.fnQueue.length;e++)this.fnQueue.pop()();this.currentVideo+=1,this.currentVideo>=this.list.length&&(this.currentVideo=0),this.element.attr("src",this.path+this.list[this.currentVideo]),this.element[0].play()},queueFn:function(e){"use strict";this.fnQueue.push(e)},queueRefresh:function(){"use strict";this.fnQueue.push(function(){location.reload(!0)})}},layoutParser={output:"",layout:{},parse:function(e){"use strict";this.layout=e,this.recursiveParse(e,{id:e[0].parent}),$("div[data-height], div[data-width]").each(function(e,t){var n=$(t),r=n.attr("data-height"),i=n.attr("data-width"),s;typeof r!="undefined"?(s=r/100*(n.parent().height()-1),n.height(s+"px")):(s=i/100*(n.parent().width()-1),n.width(s+"px"))})},queueReloadData:function(e){"use strict";setTimeout(function(){videoPlayer.queueFn(function(){layoutParser.loadData()})},e),setTimeout(function(){layoutParser.queueReloadData(e)},e)},loadData:function(e){"use strict";typeof e=="undefined"&&(e=this.layout);for(var t=0;t<e.length;t++){var n=e[t];typeof n.content=="function"&&n.content(),typeof n.content=="object"&&this.loadData(n.content)}},recursiveParse:function(e,t){"use strict";for(var n=0;n<e.length;n++){var r=e[n],i="",s="",o="",u="",a="";u="<div id='"+r.id+"'",u+=">",a="</div>",i=u+"<!-- !wrapin#"+r.id+"-->\n"+i,s+=a+"<!-- /wrapin#"+r.id+"-->\n",o+=i,typeof r.content=="function"&&(r.title&&(o+="<h1>"+r.title+"</h1>"),o+="<div class='content'>"+r.id+"</div>\n"),o+=s,$(o).appendTo("#"+t.id).css(r.css||{});var f=$("#"+r.id);typeof r.content=="object"?(r.orient==="horizontal"?(f.attr("data-height",r.size),f.addClass("hbox")):(f.attr("data-width",r.size),f.addClass("vbox")),this.recursiveParse(r.content,r)):t.orient==="horizontal"?f.attr("data-width",r.size||100/t.content.length):f.attr("data-height",r.size||100/t.content.length)}}},imdbAPI={get_movie:function(e,t){"use strict";$.ajax({url:"http://www.imdbapi.com/",data:{t:e.title},dataType:"jsonp",timeout:1e4,success:function(n){n.hasOwnProperty("Title")&&n.Title.toLowerCase()===e.title.toLowerCase()?(e.attachment=n.Poster,e.title=n.Title,e.description=n.Plot,t(e)):t(e)},error:function(){t(e)}})}},CalData={write_table:function(e,t,n){"use strict";var r,i,s=this.auto_format(n);n=s[0],r=s[1],i=s[2];var o="<table>";if(e.length===0){$(t).html("No events");return}for(var u=0;u<e.length;u++){var a=e[u],f="";f=n.replace(/s\((.*?)\)/,a.start_time.toString(r)),f=f.replace(/e\((.*?)\)/,a.end_time.toString(i)),f=f.replace(/t\(\)/,a.title),f=f.replace(/d\(\)/,a.description),f=f.replace(/\n/g,"<br/>"),f=f.replace(/\|/g,"</td><td>"),o+="<tr><td>"+f+"</td></tr>"}o+="</table>",$(t).html(o)},ticker_html:function(e,t,n,r){"use strict";var i="",s="";return s=t.replace(/s\(([\s\S]*?)\)/gm,e.start_time.toString(n)),s=s.replace(/e\(([\s\S]*?)\)/gm,e.end_time.toString(r)),s=s.replace(/\n/g,"<br/>"),i+="<div class='item' style='display: none'>",e.attachment&&(i+="<img src='"+e.attachment+"' />"),i+="<div class='title'>"+e.title+"</div>",i+="<div class='time'>"+s+"</div>",i+="<div class='description'>"+e.description+"</div>",i+="</div>",i},write_ticker:function(e,t,n,r){"use strict";var i,s,o=new Ticker({element:t}),u=this.auto_format(n);n=u[0],i=u[1],s=u[2],$(t).addClass("ticker");if(e.length===0){$(t).html("No events");return}$(t).html("");for(var a=0;a<e.length;a++){var f=e[a];o.addItem(this.ticker_html(f,n,i,s))}},write_movies:function(e,t,n){"use strict";this.write_ticker(e,t,n,!0)},auto_format:function(e){"use strict";var t,n;return typeof e=="undefined"?(t="h:mm",n="h:mm",e="s() - e() &mdash; t()"):(e.replace(/s\(([\s\S]*?)\)/m,""),t=RegExp.$1,e.replace(/e\(([\s\S]*?)\)/m,""),n=RegExp.$1),[e,t,n]},makeCallback:function(e,t,n,r,i){"use strict";return function(){e.addItem(CalData.ticker_html(t,n,r,i))}}},YConnect={date_format:"yyyy/MM/dd",get_calendar:function(e,t){"use strict";var n="http://api.ywamconnect.net/menu/get.php",r={format:"json"},i={},s=[],o=Date.today(),u;switch(e){case"today":u=o;break;case"tomorrow":u=o.addDays(1);break;default:u=o}var a=[];r.month=u.getMonth()+1,r.year=u.getFullYear(),i=r,a=u.toString(this.date_format);var f=$.ajax({url:n,data:i,dataType:"jsonp",timeout:1e4});f.success(function(e){e=e.data[a];for(var n in e)e.hasOwnProperty(n)&&s.push(new Event({title:n.toLowerCase().capitalize(),description:e[n]}));s=s.sort(by_mealtime),t(s)}),f.error(function(){})}},GCal={service:new google.gdata.calendar.CalendarService("konaSignage-app"),kona_schedule:"or2b5kqjl58ndf8ien8atkcplg%40group.calendar.google.com",kona_events:"o2jfjbba7bcrhkk5p3scfqj7vc%40group.calendar.google.com",mauka_theater:"oebubbrli984mh257hd986td80%40group.calendar.google.com",get_calendar:function(e,t,n,r){"use strict";typeof r=="undefined"&&(r=0);var i="https://www.google.com/calendar/feeds/"+e+"/public/full-noattendees",s=new google.gdata.calendar.CalendarEventQuery(i),o,u,a=Date.today(),f=[];switch(t){case"today":f=[a];break;case"tomorrow":f=[a.addDays(1)];break;case"week":f=[a,a.clone().addDays(7)];break;case"upcoming":f=[a,!1];break;default:}f.length>1?(o=new google.gdata.DateTime(f[0]),f[1]?u=new google.gdata.DateTime(f[1].clone().set({hour:23,minute:59,second:59})):u=null):(o=new google.gdata.DateTime(f[0]),u=new google.gdata.DateTime(f[0].clone().set({hour:23,minute:59,second:59}))),s.setOrderBy("starttime"),s.setSortOrder("ascending"),s.setSingleEvents(!0),s.setMinimumStartTime(o),s.setMaximumStartTime(u);var l=[];this.service.getEventsFeed(s,function(e){var t=e.feed.entry;for(var r=0;r<t.length;r++){var i=t[r];l.push(new Event({title:i.getTitle().getText(),start_time:google.gdata.DateTime.fromIso8601(i.getTimes()[0].startTime).date,end_time:google.gdata.DateTime.fromIso8601(i.getTimes()[0].endTime).date,location:i.getLocations()[0].valueString,description:i.getSummary()}))}n(l)},function(){r>=3?videoPlayer.queueRefresh():GCal.get_calendar(e,t,n,r+1)})},get_two_calendars:function(e,t,n,r){"use strict";this.get_calendar(e,n,function(e){GCal.get_calendar(t,n,function(t){var n=$.merge(e,t);n=n.sort(by_time),r(n)})})}};